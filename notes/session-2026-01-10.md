# Dream Stream - Session Notes (2026-01-10)

## Architecture Decisions

### Platform Strategy
- **Primary**: Mobile-friendly Web App (PWA)
- **Deployment**: GitHub Pages (static hosting)
- **No backend required**: All data stored locally via AsyncStorage
- **No authentication needed**: Everything runs client-side

### TTS Strategy
1. **Pre-generated audio** (primary): Use Coqui XTTS v2 to generate high-quality Opus files
   - ~350 MB total for 25 dreams (Opus @ 64kbps)
   - Script: `scripts/generate_audio.py`
   - Hosted alongside static assets on GitHub/CDN
2. **Kokoro-82M fallback** (future): Client-side TTS via kokoro-js for custom content
   - ~90 MB model download on first use
   - Runs entirely in browser via ONNX/WASM

### Sleep Detection Strategy
**MVP: Audio-based detection via Meyda** (open-source, free)
- Uses microphone to detect breathing patterns
- Estimates sleep stages (awake, light, deep, REM)
- File: `services/sleep.ts`

**Future: Comprehensive wearable support** (see `docs/WEARABLE_ROADMAP.md`)
- Target: 90%+ of wearables people own
- Requires native companion apps for proprietary protocols
- Platforms: Apple Watch, WearOS, Fitbit, Oura, Garmin, etc.

### Storage (No Auth)
- All preferences stored locally via AsyncStorage
- Favorites, playback progress, history - all local
- File: `lib/storage.ts`

## Implementation Status

| Feature | Status | Notes |
|---------|--------|-------|
| 25 lucid dream narratives | Done | With [PAUSE] markers |
| Courier Prime font | Done | Google Fonts |
| Local storage service | Done | Preferences, favorites, history, TTS cache |
| TTS service stub | Done | OpenAI API + Web Speech fallback |
| Audio generation script | Done | Python + XTTS (`scripts/generate_audio.py`) |
| DreamPlayer (audio) | Done | expo-av based |
| Adaptive music service | Done | Multiple styles |
| Sleep detection service | Done | Meyda-based breathing analysis |
| Wearable roadmap | Done | `docs/WEARABLE_ROADMAP.md` |
| PWA configuration | Done | app.json web config |
| GitHub Pages deploy | Done | `.github/workflows/deploy.yml` |
| Remove auth code | Pending | Low priority |

## File Changes This Session

### New Files
- `lib/storage.ts` - Enhanced with preferences, favorites, history, TTS cache
- `services/sleep.ts` - Meyda-based breathing detection + session management
- `scripts/generate_audio.py` - Pre-generate TTS audio with XTTS
- `docs/WEARABLE_ROADMAP.md` - Comprehensive wearable integration plan
- `.github/workflows/deploy.yml` - GitHub Pages deployment

### Modified Files
- `lib/constants.ts` - Added new storage keys
- `app.json` - Added PWA web configuration
- `package.json` - Added meyda dependency

## Commands

### Development
```bash
npm run web  # Start dev server
```

### Build for GitHub Pages
```bash
npx expo export --platform web
# Output in ./dist folder
```

### Pre-generate Audio
```bash
pip install TTS pydub
python scripts/generate_audio.py
# Output in ./public/audio/dreams/
```

### Type Check
```bash
npm run typecheck  # Should pass
```

## Wearable Support Plan

| Phase | Platforms | Method |
|-------|-----------|--------|
| MVP | None (audio-based) | Meyda breathing detection |
| v1.1 | Fitbit, Oura, Whoop, Garmin | Cloud API OAuth (polling) |
| v1.2 | WearOS (Samsung, Pixel, Fossil) | Native Kotlin companion app |
| v1.3 | Apple Watch | Native Swift companion app |
| v2.0 | All | Unified React Native bridge app |

## Next Steps

1. Test the web app locally: `npm run web`
2. Generate pre-recorded audio: `python scripts/generate_audio.py`
3. Push to GitHub and enable Pages
4. Test sleep detection with microphone
5. (Optional) Remove unused auth code

## Continuation Prompt

```
Continue Dream Stream at `/Users/jmanning/dream-stream/`.

## Current State
- Branch: `001-mvp`
- TypeScript: Compiles clean (`npm run typecheck`)
- Platform: Mobile-friendly PWA (GitHub Pages)

## Architecture
- 25 lucid dream text narratives â†’ Pre-generated audio (XTTS)
- Sleep detection: Meyda-based breathing analysis (no wearable needed)
- All storage local (AsyncStorage) - no auth, no cloud sync
- Future: Native companion apps for wearable integration

## Recently Completed
1. Enhanced local storage service (preferences, favorites, history)
2. Meyda-based sleep detection service
3. Audio pre-generation script (Python + XTTS)
4. Wearable integration roadmap (docs/WEARABLE_ROADMAP.md)
5. PWA configuration + GitHub Pages workflow

## Key Files
- services/sleep.ts - Breathing detection + sleep session management
- lib/storage.ts - Local persistence (no auth)
- scripts/generate_audio.py - Pre-generate TTS audio
- docs/WEARABLE_ROADMAP.md - Wearable support plan
- .github/workflows/deploy.yml - GitHub Pages deployment

## Pending
- Remove unused auth code (low priority)
- Test end-to-end flow
- Generate actual audio files

## Commands
npm run web          # Dev server
npm run typecheck    # Verify types
npx expo export --platform web  # Build for deployment
```
