openapi: 3.1.0
info:
  title: Dream Stream API
  description: |
    REST API for Dream Stream - "Netflix for dreams"
    
    This API is auto-generated by Supabase PostgREST with custom Edge Functions
    for specialized operations.
  version: 1.0.0
  contact:
    name: Dream Stream Team

servers:
  - url: https://{project-ref}.supabase.co/rest/v1
    description: Supabase REST API
  - url: https://{project-ref}.supabase.co/functions/v1
    description: Supabase Edge Functions

tags:
  - name: Dreams
    description: Dream content discovery and details
  - name: Auth
    description: User authentication
  - name: Favorites
    description: User saved dreams
  - name: Progress
    description: Playback progress tracking
  - name: Categories
    description: Dream categories
  - name: Sleep
    description: Wearable devices and dream launching (P4)

paths:
  # ============================================
  # DREAMS
  # ============================================
  /dreams:
    get:
      tags: [Dreams]
      summary: List dreams
      description: Get paginated list of dreams with optional filtering
      parameters:
        - name: select
          in: query
          schema:
            type: string
            default: "*,category:categories(*)"
          description: Fields to return (PostgREST select)
        - name: category_id
          in: query
          schema:
            type: string
            format: uuid
          description: Filter by category
        - name: is_featured
          in: query
          schema:
            type: boolean
          description: Filter featured dreams only
        - name: order
          in: query
          schema:
            type: string
            default: created_at.desc
          description: Sort order
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
          description: Number of results
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Pagination offset
      responses:
        '200':
          description: List of dreams
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Dream'
          headers:
            Content-Range:
              schema:
                type: string
              description: Pagination info (e.g., "0-19/150")

  /dreams/{id}:
    get:
      tags: [Dreams]
      summary: Get dream by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: select
          in: query
          schema:
            type: string
            default: "*,category:categories(*),tags:dream_tags(tag)"
      responses:
        '200':
          description: Dream details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Dream'
        '404':
          description: Dream not found

  /rpc/search_dreams:
    post:
      tags: [Dreams]
      summary: Full-text search dreams
      description: Search dreams by title and description
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [query]
              properties:
                query:
                  type: string
                  description: Search query
                  example: "flying over mountains"
                limit:
                  type: integer
                  default: 20
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Dream'

  # ============================================
  # CATEGORIES
  # ============================================
  /categories:
    get:
      tags: [Categories]
      summary: List all categories
      parameters:
        - name: order
          in: query
          schema:
            type: string
            default: sort_order.asc
      responses:
        '200':
          description: List of categories
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'

  # ============================================
  # AUTH (Supabase Auth endpoints)
  # ============================================
  /auth/v1/signup:
    post:
      tags: [Auth]
      summary: Create new account
      description: Register a new user with email and password
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  minLength: 8
                data:
                  type: object
                  properties:
                    display_name:
                      type: string
      responses:
        '200':
          description: Account created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Invalid input or email already exists

  /auth/v1/token:
    post:
      tags: [Auth]
      summary: Sign in
      description: Authenticate with email and password
      parameters:
        - name: grant_type
          in: query
          required: true
          schema:
            type: string
            enum: [password]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials

  /auth/v1/logout:
    post:
      tags: [Auth]
      summary: Sign out
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Signed out successfully

  # ============================================
  # FAVORITES
  # ============================================
  /favorites:
    get:
      tags: [Favorites]
      summary: Get user's favorites
      security:
        - bearerAuth: []
      parameters:
        - name: select
          in: query
          schema:
            type: string
            default: "*,dream:dreams(*,category:categories(*))"
        - name: order
          in: query
          schema:
            type: string
            default: created_at.desc
      responses:
        '200':
          description: List of favorites
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Favorite'
        '401':
          description: Not authenticated

    post:
      tags: [Favorites]
      summary: Add dream to favorites
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [dream_id]
              properties:
                dream_id:
                  type: string
                  format: uuid
      responses:
        '201':
          description: Added to favorites
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Favorite'
        '401':
          description: Not authenticated
        '409':
          description: Already in favorites

  /favorites/{id}:
    delete:
      tags: [Favorites]
      summary: Remove from favorites
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Removed from favorites
        '401':
          description: Not authenticated
        '404':
          description: Favorite not found

  # ============================================
  # PLAYBACK PROGRESS
  # ============================================
  /playback_progress:
    get:
      tags: [Progress]
      summary: Get all progress for user
      security:
        - bearerAuth: []
      parameters:
        - name: completed
          in: query
          schema:
            type: boolean
          description: Filter by completion status
      responses:
        '200':
          description: List of progress records
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PlaybackProgress'

  /rpc/upsert_progress:
    post:
      tags: [Progress]
      summary: Update playback progress
      description: Create or update progress for a dream (upsert)
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [dream_id, position_seconds]
              properties:
                dream_id:
                  type: string
                  format: uuid
                position_seconds:
                  type: integer
                  minimum: 0
                completed:
                  type: boolean
                  default: false
      responses:
        '200':
          description: Progress updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlaybackProgress'
        '401':
          description: Not authenticated

  # ============================================
  # WEARABLE DEVICES (P4)
  # ============================================
  /wearable_devices:
    get:
      tags: [Sleep]
      summary: List user's wearable devices
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of connected devices
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/WearableDevice'
        '401':
          description: Not authenticated

    post:
      tags: [Sleep]
      summary: Link a new wearable device
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [device_type]
              properties:
                device_type:
                  type: string
                  enum: [apple_watch, fitbit, oura, garmin, generic]
                device_name:
                  type: string
                platform_id:
                  type: string
      responses:
        '201':
          description: Device linked
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WearableDevice'
        '401':
          description: Not authenticated

  /wearable_devices/{id}:
    delete:
      tags: [Sleep]
      summary: Unlink a wearable device
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Device unlinked
        '401':
          description: Not authenticated
        '404':
          description: Device not found

  # ============================================
  # DREAM LAUNCH QUEUE (P4)
  # ============================================
  /dream_launch_queue:
    get:
      tags: [Sleep]
      summary: Get user's dream launch queue
      security:
        - bearerAuth: []
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, ready, launched, completed, cancelled]
      responses:
        '200':
          description: Launch queue entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/DreamLaunchQueue'

    post:
      tags: [Sleep]
      summary: Queue a dream for launch
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [dream_id]
              properties:
                dream_id:
                  type: string
                  format: uuid
                trigger_mode:
                  type: string
                  enum: [auto, manual]
                  default: manual
                target_sleep_stage:
                  type: string
                  enum: [rem, light, any]
                  description: Required when trigger_mode is 'auto'
      responses:
        '201':
          description: Dream queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DreamLaunchQueue'
        '400':
          description: Invalid request (e.g., auto mode without sleep stage)
        '401':
          description: Not authenticated
        '409':
          description: User already has a pending/ready dream

  /dream_launch_queue/{id}:
    patch:
      tags: [Sleep]
      summary: Update launch queue entry status
      description: Used to mark ready, launch manually, or cancel
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  type: string
                  enum: [ready, launched, cancelled]
      responses:
        '200':
          description: Status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DreamLaunchQueue'
        '400':
          description: Invalid status transition
        '401':
          description: Not authenticated
        '404':
          description: Queue entry not found

    delete:
      tags: [Sleep]
      summary: Cancel and remove queued dream
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Queue entry removed
        '401':
          description: Not authenticated

  # ============================================
  # SHARING (Edge Function)
  # ============================================
  /share:
    post:
      tags: [Dreams]
      summary: Generate share link
      description: Create a shareable link for a dream
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [dream_id]
              properties:
                dream_id:
                  type: string
                  format: uuid
      responses:
        '200':
          description: Share link generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                    format: uri
                    example: "https://dreamstream.app/d/abc123"
                  dream_id:
                    type: string
                    format: uuid

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT token

  schemas:
    Dream:
      type: object
      required:
        - id
        - title
        - thumbnail_url
        - mux_playback_id
        - duration_seconds
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          maxLength: 200
        description:
          type: string
          nullable: true
        thumbnail_url:
          type: string
          format: uri
        mux_playback_id:
          type: string
          description: Mux playback ID for streaming
        duration_seconds:
          type: integer
          minimum: 1
        category_id:
          type: string
          format: uuid
        is_featured:
          type: boolean
        created_at:
          type: string
          format: date-time
        view_count:
          type: integer
        category:
          $ref: '#/components/schemas/Category'
        tags:
          type: array
          items:
            type: string

    Category:
      type: object
      required:
        - id
        - name
        - slug
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
          maxLength: 50
        slug:
          type: string
          maxLength: 50
        icon:
          type: string
          nullable: true
        color:
          type: string
          pattern: '^#[0-9A-Fa-f]{6}$'
          nullable: true
        sort_order:
          type: integer

    Favorite:
      type: object
      required:
        - id
        - user_id
        - dream_id
        - created_at
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        dream_id:
          type: string
          format: uuid
        created_at:
          type: string
          format: date-time
        dream:
          $ref: '#/components/schemas/Dream'

    PlaybackProgress:
      type: object
      required:
        - id
        - user_id
        - dream_id
        - position_seconds
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        dream_id:
          type: string
          format: uuid
        position_seconds:
          type: integer
          minimum: 0
        completed:
          type: boolean
        updated_at:
          type: string
          format: date-time

    AuthResponse:
      type: object
      properties:
        access_token:
          type: string
        token_type:
          type: string
          enum: [bearer]
        expires_in:
          type: integer
        refresh_token:
          type: string
        user:
          type: object
          properties:
            id:
              type: string
              format: uuid
            email:
              type: string
              format: email
            created_at:
              type: string
              format: date-time

    Error:
      type: object
      properties:
        message:
          type: string
        code:
          type: string
        details:
          type: string

    WearableDevice:
      type: object
      required:
        - id
        - user_id
        - device_type
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        device_type:
          type: string
          enum: [apple_watch, fitbit, oura, garmin, generic]
        device_name:
          type: string
          nullable: true
        platform_id:
          type: string
          nullable: true
        is_connected:
          type: boolean
        last_sync_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time

    DreamLaunchQueue:
      type: object
      required:
        - id
        - user_id
        - dream_id
        - status
        - trigger_mode
      properties:
        id:
          type: string
          format: uuid
        user_id:
          type: string
          format: uuid
        dream_id:
          type: string
          format: uuid
        status:
          type: string
          enum: [pending, ready, launched, completed, cancelled]
        trigger_mode:
          type: string
          enum: [auto, manual]
        target_sleep_stage:
          type: string
          enum: [rem, light, deep, awake, any]
          nullable: true
        launched_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        dream:
          $ref: '#/components/schemas/Dream'
